---
import MainLayout from '../layouts/MainLayout.astro';
import { getEntry } from 'astro:content';
import TableOfContents from '../components/TableOfContents.astro';

const guideEntry = await getEntry('docs', 'linux-for-pirates');

if (!guideEntry) {
  throw new Error("Could not find linux-for-pirates document in content collection");
}

const { Content, headings } = await guideEntry.render();

// Filter headings to include only h2 and h3 (depth 2 and 3)
const tocHeadings = headings.filter(heading => heading.depth <= 3);

// Check if we have headings to show
const hasHeadings = tocHeadings && tocHeadings.length > 0;
---

<MainLayout 
  title="Linux for Pirates!" 
  description="A guide to Linux from a pirate perspective"
  ogImage="/images/linux-for-pirates-og.jpg"
>
  <div class="markdown-content overflow-hidden w-full">
    {hasHeadings && <TableOfContents headings={tocHeadings} />}
    <Content />
  </div>
</MainLayout>

<script is:inline>
  // Process the table of contents
  document.addEventListener('DOMContentLoaded', () => {
    const contentSection = document.querySelector('.markdown-content');
    if (!contentSection) return;
    
    // Find the manual TOC section - look for the exact heading text from the markdown
    const tocHeader = Array.from(contentSection.querySelectorAll('h2')).find(
      h2 => h2.textContent?.includes('Table of Contents')
    );
    
    if (tocHeader) {
      // Find the TOC list (it should be the next ul after the tocHeader)
      let tocList = tocHeader.nextElementSibling;
      
      // Keep searching for the next list until we find a ul or run out of elements
      while (tocList && tocList.tagName !== 'UL') {
        tocList = tocList.nextElementSibling;
      }
      
      // If found, remove both the header and the list
      if (tocList) {
        // We've confirmed we found the manual TOC, so remove it
        tocHeader.remove();
        tocList.remove();
      }
    }
    
    // Check for any empty table-of-contents divs and hide them
    const emptyTocs = document.querySelectorAll('.table-of-contents:not(:has(li))');
    emptyTocs.forEach(toc => {
      toc.style.display = 'none';
    });
  });

  // Make external links open in new tabs
  document.addEventListener('DOMContentLoaded', () => {
    const externalLinks = document.querySelectorAll('.markdown-content a[href^="http"]');
    externalLinks.forEach(link => {
      if (!link.hasAttribute('target')) {
        link.setAttribute('target', '_blank');
        link.setAttribute('rel', 'noopener noreferrer');
      }
    });
  });
</script>

<style is:global>
  /* MAJOR HEADING OVERRIDES */
  .markdown-content h1,
  .markdown-content h2,
  .markdown-content h3,
  .markdown-content h4,
  .markdown-content h5,
  .markdown-content h6 {
    color: #8f36e6 !important; /* Use purple instead of lime green */
    font-family: 'Cinzel Decorative', serif !important;
    max-width: 100% !important;
    overflow-wrap: break-word !important;
    word-wrap: break-word !important;
    word-break: normal !important;
    hyphens: auto !important;
    margin-right: 0 !important;
    border: none !important;
    white-space: normal !important;
    line-height: 1.3 !important;
  }
  
  .dark .markdown-content h1,
  .dark .markdown-content h2,
  .dark .markdown-content h3,
  .dark .markdown-content h4,
  .dark .markdown-content h5,
  .dark .markdown-content h6 {
    color: #a3fe0d !important; /* Keep lime green only in dark mode */
  }
  
  /* Title hierarchy with proper sizing */
  .markdown-content h1 {
    font-size: 2.5rem !important;
    margin-top: 2rem !important;
    margin-bottom: 1.5rem !important;
    font-weight: 700 !important;
  }
  
  .markdown-content h2 {
    font-size: 2rem !important;
    margin-top: 2.5rem !important;
    margin-bottom: 1.25rem !important;
    font-weight: 700 !important;
  }
  
  .markdown-content h3 {
    font-size: 1.75rem !important;
    margin-top: 2rem !important;
    margin-bottom: 1rem !important;
    font-weight: 700 !important;
  }
  
  .markdown-content h4 {
    font-size: 1.5rem !important;
    margin-top: 1.75rem !important;
    margin-bottom: 0.75rem !important;
    font-weight: 700 !important;
  }
  
  .markdown-content h5 {
    font-size: 1.25rem !important;
    margin-top: 1.5rem !important;
    margin-bottom: 0.5rem !important;
    font-weight: 700 !important;
  }
  
  .markdown-content h6 {
    font-size: 1.1rem !important;
    margin-top: 1.25rem !important;
    margin-bottom: 0.5rem !important;
    font-weight: 700 !important;
  }
  
  /* Fix section titles and sub-headings */
  .markdown-content h1 + p,
  .markdown-content h2 + p,
  .markdown-content h3 + p {
    margin-top: 0.5rem !important;
  }
  
  /* Fix code inside headings */
  .markdown-content h1 code,
  .markdown-content h2 code,
  .markdown-content h3 code,
  .markdown-content h4 code,
  .markdown-content h5 code,
  .markdown-content h6 code {
    font-size: 0.85em !important;
    word-break: break-word !important;
    background-color: rgba(143, 54, 230, 0.1) !important;
    padding: 0.2em 0.4em !important;
    border-radius: 0.25rem !important;
    font-weight: 500 !important;
    font-family: monospace !important;
  }
  
  .dark .markdown-content h1 code,
  .dark .markdown-content h2 code,
  .dark .markdown-content h3 code,
  .dark .markdown-content h4 code,
  .dark .markdown-content h5 code,
  .dark .markdown-content h6 code {
    background-color: rgba(163, 254, 13, 0.1) !important;
  }
  
  /* Ensure proper text flow in headings */
  .markdown-content h1 *,
  .markdown-content h2 *,
  .markdown-content h3 *,
  .markdown-content h4 *,
  .markdown-content h5 *,
  .markdown-content h6 * {
    display: inline !important;
    vertical-align: baseline !important;
    font-size: inherit !important;
    font-weight: inherit !important;
    line-height: inherit !important;
    color: inherit !important;
  }
  
  /* Force code blocks to behave */
  .markdown-content pre {
    max-width: 100% !important;
    overflow-x: auto !important;
    white-space: pre !important;
    padding: 1rem !important;
    border-radius: 0.5rem !important;
    margin: 1.5rem 0 !important;
    background-color: #f8f9fa !important;
    border: 1px solid #e9ecef !important;
  }
  
  .dark .markdown-content pre {
    background-color: #1e293b !important;
    border-color: #334155 !important;
  }
  
  /* Ensure tables don't overflow */
  .markdown-content table {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    overflow-x: auto !important;
    border-collapse: collapse !important;
    margin: 1.5rem 0 !important;
  }
  
  .markdown-content table th,
  .markdown-content table td {
    padding: 0.5rem 1rem !important;
    border: 1px solid #e2e8f0 !important;
    word-break: normal !important;
  }
  
  .dark .markdown-content table th,
  .dark .markdown-content table td {
    border-color: #334155 !important;
  }
  
  /* Fix inline links for better flow */
  .markdown-content a {
    word-break: break-word !important;
    overflow-wrap: break-word !important;
    color: #8f36e6 !important;
    text-decoration: none !important;
    transition: text-decoration 0.2s ease !important;
  }
  
  .dark .markdown-content a {
    color: #a3fe0d !important;
  }
  
  .markdown-content a:hover {
    text-decoration: underline !important;
  }
  
  /* Fix inline code elements to match the design */
  .markdown-content p code,
  .markdown-content li code,
  .markdown-content td code {
    font-size: 0.9em !important;
    word-break: break-word !important;
    background-color: rgba(143, 54, 230, 0.1) !important;
    color: #8f36e6 !important;
    padding: 0.2em 0.4em !important;
    border-radius: 0.25rem !important;
    font-weight: 500 !important;
    font-family: monospace !important;
  }
  
  .dark .markdown-content p code,
  .dark .markdown-content li code,
  .dark .markdown-content td code {
    background-color: rgba(163, 254, 13, 0.1) !important;
    color: #a3fe0d !important;
  }
  
  /* Mobile optimizations */
  @media (max-width: 640px) {
    .markdown-content h1 { font-size: 1.8rem !important; }
    .markdown-content h2 { font-size: 1.6rem !important; }
    .markdown-content h3 { font-size: 1.4rem !important; }
    .markdown-content h4 { font-size: 1.2rem !important; }
    .markdown-content h5 { font-size: 1.1rem !important; }
    .markdown-content h6 { font-size: 1rem !important; }
    
    .markdown-content pre,
    .markdown-content code {
      font-size: 0.8rem !important;
    }
  }
</style>
